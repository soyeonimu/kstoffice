<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SE 메인컨테이너 붙여넣기 에디터</title>
  <link rel="preconnect" href="https://unpkg.com">
  <!-- Sanitizer & MD 변환기 -->
  <script src="https://unpkg.com/dompurify@3.0.8/dist/purify.min.js"></script>
  <script src="https://unpkg.com/turndown@7.2.0/dist/turndown.js"></script>
  <style>
    :root{--bg:#0b1020;--panel:#11182a;--muted:#a7b0c0;--fg:#eaf0ff;--brand:#4da3ff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;background:#0b1020;color:var(--fg)}
    header{padding:1rem 1.25rem;border-bottom:1px solid #15203a;background:rgba(0,0,0,.25);backdrop-filter:saturate(1.2) blur(6px);position:sticky;top:0}
    header h1{margin:0;font-size:1.05rem;font-weight:700}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:1rem;padding:1rem;max-width:1200px;margin:0 auto}
    .card{background:var(--panel);border:1px solid #15203a;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:0.9rem 1rem;border-bottom:1px solid #15203a;font-size:.95rem;color:#cfe0ff}
    .body{padding:1rem}
    .pastezone{min-height:320px;background:#0c1426;border:1px dashed #263554;border-radius:12px;padding:1rem;outline:none;overflow:auto}
    .pastezone:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(77,163,255,.15)}
    .hint{font-size:.86rem;color:var(--muted);margin:.5rem 0 0}
    .btns{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
    button{background:#152747;border:1px solid #2a3d63;color:#eaf0ff;border-radius:10px;padding:.6rem .8rem;font-weight:600;cursor:pointer}
    button.primary{background:var(--brand);border-color:#3f8fe0;color:#07101f}
    textarea, .preview{width:100%;min-height:260px;background:#0c1426;border:1px solid #263554;border-radius:12px;color:#eaf0ff;padding:0.75rem;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;line-height:1.5;overflow:auto}
    .pair{display:grid;grid-template-columns:1fr;gap:.75rem}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    @media (max-width: 960px){.wrap{grid-template-columns:1fr}.two{grid-template-columns:1fr}}
    .muted{color:var(--muted);font-size:.85rem}
  </style>
</head>
<body>
  <header><h1>네이버 SmartEditor ▶ “se-main-container” 붙여넣기 에디터</h1></header>

  <div class="wrap">
    <!-- 입력 -->
    <section class="card">
      <h2>1) 원본 붙여넣기</h2>
      <div class="body">
        <div id="input" class="pastezone" contenteditable="true"
             placeholder="여기에 붙여넣기 (Ctrl/⌘+V)"></div>
        <p class="hint">네이버 글의 <code>&lt;div class="se-main-container"&gt;</code>만 복사해서 붙여넣으세요. (전체 페이지를 붙여도 자동 추출돼요)</p>
        <div class="btns">
          <button id="btnPaste" title="클립보드에서 HTML 읽기">클립보드에서 붙여넣기</button>
          <button id="btnClear">비우기</button>
          <span class="muted">붙여넣는 즉시 오른쪽에 ‘정리 결과’가 생성됩니다.</span>
        </div>
      </div>
    </section>

    <!-- 출력 -->
    <section class="card">
      <h2>2) 정리 결과 (클래스/스타일 제거 + 이미지 src 정리 + 안전화)</h2>
      <div class="body pair">
        <div class="two">
          <button id="copyHtml" class="primary">HTML 복사</button>
          <button id="copyMd">Markdown 복사</button>
        </div>
        <textarea id="outHtml" spellcheck="false" placeholder="여기에 정리된 HTML이 표시됩니다."></textarea>
        <div class="two">
          <button id="downloadHtml">.html 다운로드</button>
          <button id="renderPreview">미리보기 갱신</button>
        </div>
        <div id="preview" class="preview"></div>
        <p class="muted">⚠️ 이미지 링크는 원본(네이버) 주소를 사용합니다. 영구 보관하려면 이미지 재업로드가 필요합니다.</p>
      </div>
    </section>
  </div>

<script>
  const $ = (s)=>document.querySelector(s);
  const input = $('#input');
  const outHtml = $('#outHtml');
  const preview = $('#preview');

  // 붙여넣기 이벤트 가로채서 HTML 우선 처리
  input.addEventListener('paste', async (e)=>{
    e.preventDefault();
    const html = await readFromClipboardEvent(e);
    if(html){ process(html); }
  });

  // 버튼: 클립보드에서 직접 읽기 (HTTPS 환경에서 동작)
  $('#btnPaste').addEventListener('click', async ()=>{
    try{
      if(navigator.clipboard.read){
        const items = await navigator.clipboard.read();
        for(const item of items){
          if(item.types.includes('text/html')){
            const blob = await item.getType('text/html');
            const html = await blob.text();
            process(html);
            return;
          }
        }
      }
      // fallback: 일반 텍스트
      const txt = await navigator.clipboard.readText();
      process(txt);
    }catch(err){
      alert('클립보드 접근이 차단되었어요. 입력창에 직접 붙여넣기(Ctrl/⌘+V) 해주세요.');
    }
  });

  $('#btnClear').addEventListener('click', ()=>{
    input.innerHTML = ''; outHtml.value = ''; preview.innerHTML = '';
  });

  $('#copyHtml').addEventListener('click', ()=>copyText(outHtml.value));
  $('#copyMd').addEventListener('click', ()=>{
    const turndown = new TurndownService({headingStyle:'atx',codeBlockStyle:'fenced',emDelimiter:'_'});
    copyText(turndown.turndown(outHtml.value));
  });

  $('#downloadHtml').addEventListener('click', ()=>{
    download('cleaned.html', outHtml.value);
  });

  $('#renderPreview').addEventListener('click', ()=>{
    preview.innerHTML = outHtml.value;
  });

  async function readFromClipboardEvent(e){
    // 우선순위: HTML -> 텍스트
    const html = e.clipboardData.getData('text/html');
    if(html) return html;
    const txt = e.clipboardData.getData('text/plain');
    return txt || '';
  }

  function process(rawHtml){
    // 1) 파싱
    const parser = new DOMParser();
    const doc = parser.parseFromString(rawHtml, 'text/html');

    // 2) SmartEditor 본문 노드 탐색(여러 형태 대비)
    let container =
      doc.querySelector('.se-main-container, .se_main_container, [class*="se-main"][class*="container"]') ||
      doc.querySelector('#content, article, main') ||
      doc.body;

    // 3) 본문만 임시 문서로 복사
    const temp = document.implementation.createHTMLDocument('');
    const holder = temp.body.appendChild(temp.createElement('div'));
    holder.innerHTML = container.outerHTML ? container.outerHTML : container.innerHTML;

    // 4) 불필요 속성/래퍼 제거, 이미지 src 정리
    cleanup(holder);

    // 5) 보안/태그 제한 Sanitize
    const clean = DOMPurify.sanitize(holder.innerHTML, {
      ALLOWED_TAGS: [
        'h1','h2','h3','h4','p','strong','em','b','i','u','a','ul','ol','li',
        'blockquote','img','figure','figcaption','table','thead','tbody','tr','th','td','br','hr','pre','code','span'
      ],
      ALLOWED_ATTR: ['href','target','rel','title','src','alt','width','height','rowspan','colspan']
    });

    outHtml.value = prettyHtml(clean);
    preview.innerHTML = outHtml.value;
  }

  function cleanup(root){
    // se-wrapper 같은 바깥 래퍼가 있으면 그 안쪽만 취함
    const first = root.querySelector('.se-main-container, .se_main_container');
    if(first){ root.innerHTML = first.innerHTML; }

    // 모든 엘리먼트 순회
    root.querySelectorAll('*').forEach(el=>{
      // 1) 클래스/스타일/데이터 속성 제거
      el.removeAttribute('class');
      el.removeAttribute('style');
      [...el.attributes].forEach(a=>{
        if(a.name.startsWith('data-')) el.removeAttribute(a.name);
        if(a.name.startsWith('aria-')) el.removeAttribute(a.name);
      });

      // 2) 링크 안전
      if(el.tagName==='A'){
        el.setAttribute('rel','noopener noreferrer');
        if(!el.getAttribute('target')) el.setAttribute('target','_blank');
      }

      // 3) 이미지 lazy-src 복구
      if(el.tagName==='IMG'){
        const cand = el.getAttribute('data-src') || el.getAttribute('data-lazy-src') || el.getAttribute('data-original') || el.src;
        if(cand && !el.getAttribute('src')) el.setAttribute('src', cand);
        // width/height 숫자만 남기기
        ['width','height'].forEach(k=>{
          const v = el.getAttribute(k);
          if(v && /\d+/.test(v)) el.setAttribute(k, v.match(/\d+/)[0]);
        });
      }

      // 4) 의미 없는 div->p 승격 (텍스트만 가진 div)
      if(el.tagName==='DIV' && el.childElementCount===0 && el.textContent.trim().length){
        const p = document.createElement('p'); p.textContent = el.textContent; el.replaceWith(p);
      }
    });
  }

  function copyText(text){
    navigator.clipboard.writeText(text).then(()=> {
      toast('복사했어요!');
    }).catch(()=> alert('복사 실패. 수동으로 Ctrl/⌘+C 를 사용하세요.'));
  }

  function download(filename, text){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([text], {type:'text/html'}));
    a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  }

  function prettyHtml(html){
    // 간단 들여쓰기 포매터 (빠르고 가벼운 버전)
    const tab = '  ';
    let out = '', indent = 0;
    html.replace(/>\s+</g,'><').split(/(?=<)/g).forEach(part=>{
      if(/^<\/\w/.test(part)) indent = Math.max(indent-1,0);
      out += tab.repeat(indent) + part.trim() + '\n';
      if(/^<\w[^>]*[^/]>$/.test(part) && !/^<(br|hr|img|input)/i.test(part)) indent++;
    });
    return out.trim();
  }

  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    t.style.cssText='position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:#1c2b4a;color:#eaf0ff;padding:.55rem .8rem;border:1px solid #2a3d63;border-radius:10px;z-index:9999';
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),1400);
  }
</script>
</body>
</html>
